<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Correcteur de documents</title>

  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background-color: #f5f5f0;
      color: #2d2d2d;
      line-height: 1.6;
      padding: 20px;
    }

    .container { max-width: 1000px; margin: 0 auto; }

    h1 {
      color: #2d2d2d;
      margin-bottom: 10px;
      font-size: 2em;
      text-align: center;
    }

    .subtitle {
      color: #666;
      margin-bottom: 30px;
      font-size: 0.95em;
      text-align: center;
    }

    .card {
      background: white;
      padding: 25px;
      border-radius: 14px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.08);
      margin-bottom: 18px;
    }

    .file-input-wrapper { position: relative; margin-bottom: 15px; }
    input[type="file"] { display: none; }

    .file-label {
      display: block;
      padding: 15px;
      background: #fafaf8;
      border: 2px dashed #cc785c;
      border-radius: 10px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
    }

    .file-label:hover {
      background: #f0f0eb;
      border-color: #b86a4e;
    }

    .file-label.has-file {
      border-style: solid;
      background: #fff8f5;
    }

    .file-info {
      margin-top: 10px;
      font-size: 0.9em;
      color: #666;
    }

	button {
	  padding: 12px 24px;
	  background-color: #cc785c;
	  color: #ffffff;
	  border: none;
	  border-radius: 10px;
	  font-size: 1em;
	  font-weight: 650;
	  cursor: pointer;
	  transition: background-color 0.2s, transform 0.1s, color 0.2s;
	  width: 100%;
	}

	button:hover:not(:disabled) { background-color: #b86a4e; }
	button:active { transform: scale(0.98); }

	button:disabled {
	  background-color: #e6e6e6;
	  color: #5f5f5f;
	  cursor: not-allowed;
	  transform: none;
	}

    .info-text {
      font-size: 0.85em;
      color: #666;
      font-style: italic;
      margin-top: 10px;
    }

    .key-management {
      text-align: center;
      margin-top: 15px;
      padding-top: 15px;
      border-top: 1px solid #e0e0e0;
    }

    .key-management a {
      font-size: 0.85em;
      color: #999;
      text-decoration: none;
      transition: color 0.3s;
    }

    .key-management a:hover { color: #cc785c; }

    .results-card { display: none; }
    .results-card.visible { display: block; }

    .results-top {
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 16px;
    }

	.errors-title {
	  font-size: 1.15em;
	  font-weight: 700;
	  color: #cc785c;
	  letter-spacing: 0.1px;
	  line-height: 1.2;
	}

    .empty-state {
      text-align: center;
      padding: 42px 15px;
      color: #999;
      border: 1px dashed #e0e0e0;
      border-radius: 12px;
      background: #fafaf8;
    }

    .empty-state-icon { font-size: 2.6em; margin-bottom: 10px; }

    .error {
      background: #ffe6e6;
      color: #c00;
      padding: 15px;
      border-radius: 10px;
      border-left: 4px solid #c00;
      margin-top: 15px;
    }

    .loading::after {
      content: '...';
      animation: dots 1.5s steps(4, end) infinite;
    }

    @keyframes dots {
      0%, 20% { content: '.'; }
      40% { content: '..'; }
      60%, 100% { content: '...'; }
    }

    /* Cartes */
    .errors-list {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }

    .err-card {
      border: 1px solid #eee;
      background: linear-gradient(180deg, #ffffff 0%, #fcfcfa 100%);
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 1px 6px rgba(0,0,0,0.05);
    }

    .err-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      padding: 14px 16px;
      background: #fafaf8;
      border-bottom: 1px solid #eee;
    }

	.err-title {
	  font-weight: 650;
	  color: #4a4a4a;
	  line-height: 1.25;
	  min-width: 0;
	  white-space: nowrap;
	  overflow: hidden;
	  text-overflow: ellipsis;
	}

	.err-title .num {
	  color: #cc785c;      /* petit accent */
	  font-weight: 650;    /* pas de 900 */
	}

    .err-body { padding: 14px 16px 16px; }

    .err-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .panel {
      border-radius: 12px;
      padding: 12px;
      border: 1px solid #eee;
      background: #fff;
    }

    .panel-title {
      font-size: 0.78em;
      font-weight: 750;
      color: #666;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      display: inline-block;
      background: #cc785c;
      opacity: 0.9;
    }

    .panel.erroneous {
      background: #fff7f7;
      border-color: #f3d2d2;
    }

    .panel.solution {
      background: #f5fbf5;
      border-color: #d6ead6;
    }

    .panel.erroneous .dot { background: #e74c3c; }
    .panel.solution .dot { background: #27ae60; }

    .panel-text {
      font-size: 0.98em;
      color: #2d2d2d;
      white-space: pre-wrap;
      word-break: break-word;
    }

	.hl {
	  background: transparent;
	  padding: 0;
	  border-radius: 0;
	  font-weight: 800; /* le gras suffit */
	}

    .problem-line {
      margin-top: 12px;
      padding-top: 10px;
      border-top: 1px dashed #eee;
      color: #555;
      font-size: 0.95em;
    }

    .problem-line strong { color: #2d2d2d; }

    .another {
      margin-top: 18px;
      padding-top: 16px;
      border-top: 1px solid #eee;
    }

    .another button {
      background: #e0e0e0;
      color: #2d2d2d;
      font-weight: 600;
    }

    .another button:hover:not(:disabled) { background: #d0d0d0; }

    @media (max-width: 860px) {
      .err-grid { grid-template-columns: 1fr; }
      .err-title { white-space: normal; }
    }

    @media (max-width: 768px) {
      body { padding: 15px; }
      h1 { font-size: 1.5em; }
      .results-top { flex-direction: column; align-items: stretch; }
      .errors-title { text-align: center; }
    }
  </style>
</head>

<body>
  <div class="container">
    <h1>üìù Correcteur de documents</h1>
    <p class="subtitle">D√©tection automatique des fautes et coquilles dans vos documents PDF et DOCX</p>

    <div class="card">
      <div class="file-input-wrapper">
        <input type="file" id="fileInput" accept=".pdf,.docx" onchange="handleFileSelect(event)" />
        <label for="fileInput" class="file-label" id="fileLabel">
          <div style="font-size: 2em; margin-bottom: 10px;">üìÑ</div>
          <div style="font-weight: 600; margin-bottom: 5px;">Cliquez pour s√©lectionner un document</div>
          <div style="font-size: 0.85em; color: #999;">Formats accept√©s : PDF, Word (.docx)</div>
        </label>
        <div id="fileInfo" class="file-info"></div>
      </div>

      <button id="correctBtn" disabled>Analyser le document</button>

      <p class="info-text">
        La correction est effectu√©e √† l'aide du mod√®le Gemini 3.0 Flash et peut prendre de quelques secondes √† 5 minutes.
      </p>

      <div class="key-management" id="keyManagement" style="display: none;">
        <a href="#" onclick="deleteGeminiKey(); return false;">üóëÔ∏è Supprimer la cl√© API Gemini</a>
      </div>
    </div>

    <div class="card results-card" id="resultsCard">
      <div class="results-top">
        <div class="errors-title" id="errorsTitle">0 erreurs trouv√©es</div>
      </div>

      <div id="errorsContainer"></div>

      <div class="another" id="anotherBlock" style="display:none;">
        <button type="button" onclick="location.reload()">Corriger un autre document</button>
      </div>
    </div>

    <div class="back-link" style="text-align:center; margin-top: 34px; padding-top: 18px; border-top:1px solid #e0e0e0;">
      <a href="index.html" style="color:#8a8a8a; text-decoration:none;">‚Üê Retour √† l'index des outils</a>
    </div>
  </div>

  <script>
    window.selectedFile = null;
    window.allErrors = [];

    function handleFileSelect(event) {
      selectedFile = event.target.files[0];
      const fileLabel = document.getElementById('fileLabel');
      const fileInfo = document.getElementById('fileInfo');
      const correctBtn = document.getElementById('correctBtn');

      if (selectedFile) {
        fileLabel.classList.add('has-file');
        fileInfo.innerHTML = `
          <strong>‚úì Fichier s√©lectionn√© :</strong> ${escapeHtml(selectedFile.name)}
          (${formatFileSize(selectedFile.size)})
        `;
        correctBtn.disabled = false;
      } else {
        fileLabel.classList.remove('has-file');
        fileInfo.innerHTML = '';
        correctBtn.disabled = true;
      }
    }

	function pluralizeErreur(n) {
	  return n === 1 ? "erreur trouv√©e" : "erreurs trouv√©es";
	}

	function setErrorsTitle(n) {
	  const t = document.getElementById('errorsTitle');
	  if (t) t.textContent = `Rapport de correction : ${n} ${pluralizeErreur(n)}`;
	}

    function displayErrors(errors) {
      const resultsCard = document.getElementById('resultsCard');
      const errorsContainer = document.getElementById('errorsContainer');
      const anotherBlock = document.getElementById('anotherBlock');

      resultsCard.classList.add('visible');
      setErrorsTitle(errors.length);

      if (errors.length === 0) {
        errorsContainer.innerHTML = `
          <div class="empty-state">
            <div class="empty-state-icon">‚ú®</div>
            <div>Aucune erreur d√©tect√©e !</div>
            <div style="font-size: 0.9em; color: #999; margin-top: 8px;">Votre document semble impeccable.</div>
          </div>
        `;
        anotherBlock.style.display = 'block';
        return;
      }

      const cards = errors.map((e, idx) => {
        const id = e.id ?? (idx + 1);
        const loc = e.localisation ?? '';
        const prob = e.probleme ?? '';
        const passage = e.passage_errone ?? '';
        const sol = e.solution ?? '';

        const passageHtml = escapeHtml(passage).replace(/\*([^*]+)\*/g, '<span class="hl">$1</span>');
        const solHtml = escapeHtml(sol);

        return `
          <div class="err-card">
            <div class="err-head">
              <div class="err-title" title="${escapeHtml(`Erreur n¬∞ ${id} : ${loc}`)}">

                Erreur n¬∞ <span class="num">${escapeHtml(String(id))}</span> : ${escapeHtml(loc)}
              </div>
            </div>

            <div class="err-body">
              <div class="err-grid">
                <div class="panel erroneous">
                  <div class="panel-title"><span class="dot"></span> Passage erron√©</div>
                  <div class="panel-text">${passageHtml}</div>
                </div>

                <div class="panel solution">
                  <div class="panel-title"><span class="dot"></span> Solution</div>
                  <div class="panel-text">${solHtml}</div>
                </div>
              </div>

              <div class="problem-line">
                <strong>Probl√®me :</strong> ${escapeHtml(prob)}
              </div>
            </div>
          </div>
        `;
      }).join('');

      errorsContainer.innerHTML = `<div class="errors-list">${cards}</div>`;
      anotherBlock.style.display = 'block';
    }

    function deleteGeminiKey() {
      const currentKey = localStorage.getItem('gemini-api-key');
      if (!currentKey) {
        alert('Aucune cl√© API Gemini enregistr√©e.');
        return;
      }
      if (confirm('Voulez-vous vraiment supprimer la cl√© API Gemini enregistr√©e ?\n\nVous devrez la saisir √† nouveau lors de la prochaine analyse.')) {
        localStorage.removeItem('gemini-api-key');
        alert('‚úì Cl√© API supprim√©e avec succ√®s');
        updateKeyManagementVisibility();
      }
    }

    function updateKeyManagementVisibility() {
      const hasKey = localStorage.getItem('gemini-api-key') !== null;
      const keyManagement = document.getElementById('keyManagement');
      if (keyManagement) keyManagement.style.display = hasKey ? 'block' : 'none';
    }

    function formatFileSize(bytes) {
      if (bytes === 0) return '0 Bytes';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text ?? '';
      return div.innerHTML;
    }

    document.addEventListener('DOMContentLoaded', updateKeyManagementVisibility);
    window.displayErrors = displayErrors;
    window.escapeHtml = escapeHtml;
    window.updateKeyManagementVisibility = updateKeyManagementVisibility;
  </script>

  <!-- ‚úÖ Mammoth pour DOCX -->
  <script src="https://unpkg.com/mammoth/mammoth.browser.min.js"></script>

  <!-- ‚úÖ Gemini + timeout 300s + Grounding (Google Search) -->
  <script type="module">
    import { GoogleGenerativeAI } from "https://esm.run/@google/generative-ai";

    const CLIENT_TIMEOUT_MS = 300000; // ‚úÖ 5 minutes

    function extLower(name) {
      const m = (name || "").toLowerCase().match(/\.([a-z0-9]+)$/);
      return m ? m[1] : "";
    }

    function arrayBufferToBase64(buffer) {
      let binary = "";
      const bytes = new Uint8Array(buffer);
      const chunkSize = 0x8000;
      for (let i = 0; i < bytes.length; i += chunkSize) {
        binary += String.fromCharCode(...bytes.subarray(i, i + chunkSize));
      }
      return btoa(binary);
    }

    function formatAnyError(err) {
      const lines = [];
      lines.push(`Type: ${err?.name || "Error"}`);
      if (err?.message) lines.push(`Message: ${err.message}`);
      if (err?.stack) {
        lines.push("");
        lines.push("Stack:");
        lines.push(err.stack);
      }
      return lines.join("\n");
    }

    function showBigErrorOnPage(err, extraHint = "") {
      const errorsContainer = document.getElementById("errorsContainer");
      const anotherBlock = document.getElementById("anotherBlock");

      window.displayErrors?.([]); // affiche le titre "0 erreurs trouv√©es" et remplace si besoin
      const detail = formatAnyError(err);
      const hint = extraHint
        ? `<div style="margin-top:10px;color:#666;font-size:0.9em;white-space:normal;">${extraHint}</div>`
        : "";

      errorsContainer.innerHTML = `
        <div class="error">
          <strong>Erreur (d√©tails complets) :</strong>
          ${hint}
          <pre style="margin-top:10px;white-space:pre-wrap;word-break:break-word;overflow:auto;background:#fff;padding:12px;border-radius:10px;border:1px solid rgba(0,0,0,0.08);max-height:420px;">${window.escapeHtml(detail)}</pre>
        </div>
      `;
      anotherBlock.style.display = "block";
    }

    async function generateWithTimeout(model, parts, ms = CLIENT_TIMEOUT_MS) {
      const timeoutPromise = new Promise((_, reject) => {
        setTimeout(() => reject(new Error("TIMEOUT_CLIENT_300S")), ms);
      });

      const reqPromise = model.generateContent({
        contents: [{ role: "user", parts }]
      });

      return await Promise.race([reqPromise, timeoutPromise]);
    }

    function buildModel(genAI, { thinkingLevel, mediaResolution }) {
      return genAI.getGenerativeModel({
        model: "gemini-3-flash-preview",

        generationConfig: {
          temperature: 0.3,
          thinkingConfig: { thinkingLevel },
          mediaResolution
        },

        tools: [
          { googleSearch: {} }
        ],
      });
    }

    function isTimeout(err) {
      const msg = (err?.message || "").toLowerCase();
      return msg.includes("timeout_client_300s") || msg.includes("timeout");
    }

    function makePrompt(kind /* "pdf" | "docx" */) {
      if (kind === "docx") {
        return `Tu es un correcteur professionnel.
Tu dois relire attentivement le document fourni et trouver toutes les coquilles et fautes √† corriger sur la forme. Ta correction doit uniquement porter sur des erreurs et coquilles (y compris les noms et r√©f√©rences le cas √©ch√©ant), pas sur le style.

Le document est fourni sous forme de blocs rep√©r√©s par des identifiants (ex: P12, H2-3, LI7).
IMPORTANT : dans "localisation", tu dois mettre l'identifiant du bloc concern√© sous une forme explicite (ex: "Paragraphe 12") ‚Äî rien d'autre.

Consignes de formatage strictes :
Ta r√©ponse doit √™tre un tableau JSON valide contenant une liste d'objets.
N'√©cris aucune phrase d'introduction ou de conclusion (pas de markdown).
Respecte scrupuleusement cette structure pour chaque erreur :
[
  {
    "id": 1,
    "localisation": "Paragraphe 12",
    "passage_errone": "Recopie le passage. Mets la faute ou coquille entre ast√©risques (ex: le *chatte* noir)",
    "probleme": "Explique simplement l'erreur (ex: accord incorrect)",
    "solution": "Le passage enti√®rement corrig√©"
  }
]

Rappel important sur "localisation" :
- Si le bloc est [P12], √©cris "Paragraphe 12"
- Si le bloc est [H2-3], √©cris "Titre 2-3"
- Si le bloc est [LI7], √©cris "√âl√©ment de liste 7"
Ne mets rien d'autre dans "localisation".`;
      }

      return `Tu es un correcteur professionnel.
Tu dois relire attentivement le document fourni et trouver toutes les coquilles et fautes √† corriger sur la forme. Ta correction doit uniquement porter sur des erreurs et coquilles (y compris les noms et r√©f√©rences le cas √©ch√©ant), pas sur le style.

Consignes de formatage strictes :
Ta r√©ponse doit √™tre un tableau JSON valide contenant une liste d'objets.
N'√©cris aucune phrase d'introduction ou de conclusion (pas de markdown).
Respecte scrupuleusement cette structure pour chaque erreur :
[
  {
    "id": 1,
    "localisation": "Page N¬∞ ou Section",
    "passage_errone": "Recopie le passage. Mets la faute ou coquille entre ast√©risques (ex: le *chatte* noir)",
    "probleme": "Explique simplement l'erreur (ex: accord incorrect)",
    "solution": "Le passage enti√®rement corrig√©"
  }
]`;
    }

    async function extractDocxToLabeledText(arrayBuffer) {
      if (!window.mammoth?.convertToHtml) {
        throw new Error("Mammoth n'est pas charg√© : impossible de lire le DOCX.");
      }

      const res = await window.mammoth.convertToHtml({ arrayBuffer });
      const html = (res?.value || "").trim();
      if (!html) return "";

      const doc = new DOMParser().parseFromString(html, "text/html");
      const body = doc.body;

      let pCount = 0;
      const hCount = { 1:0,2:0,3:0,4:0,5:0,6:0 };
      let liCount = 0;

      const blocks = [];
      const elements = body.querySelectorAll("h1,h2,h3,h4,h5,h6,p,li");

      elements.forEach(el => {
        const tag = el.tagName.toLowerCase();
        const text = (el.textContent || "").replace(/\s+\n/g, "\n").trim();
        if (!text) return;

        if (tag === "p") {
          pCount += 1;
          blocks.push(`[P${pCount}] ${text}`);
          return;
        }

        if (tag === "li") {
          liCount += 1;
          blocks.push(`[LI${liCount}] ${text}`);
          return;
        }

        const level = parseInt(tag.replace("h",""), 10);
        if (!Number.isNaN(level) && level >= 1 && level <= 6) {
          hCount[level] += 1;
          blocks.push(`[H${level}-${hCount[level]}] ${text}`);
        }
      });

      return blocks.join("\n\n");
    }

    function clampText(s, maxChars = 140000) {
      if (!s) return s;
      if (s.length <= maxChars) return s;
      return s.slice(0, maxChars) + "\n\n[... contenu tronqu√© ...]";
    }

    async function correctDocument() {
      if (!window.selectedFile) {
        alert("Veuillez s√©lectionner un fichier");
        return;
      }

      const file = window.selectedFile;
      const ext = extLower(file.name);

      const isPdf = (file.type === "application/pdf") || ext === "pdf";
      const isDocx = ext === "docx" || file.type === "application/vnd.openxmlformats-officedocument.wordprocessingml.document";

      if (!isPdf && !isDocx) {
        document.getElementById("resultsCard").classList.add("visible");
        showBigErrorOnPage(new Error("Format non pris en charge."), "Formats accept√©s : PDF, DOCX.");
        return;
      }

      let apiKey = localStorage.getItem("gemini-api-key");
      if (!apiKey) {
        apiKey = prompt(
          "Entrez votre cl√© API Google Gemini :\n\nVous pouvez obtenir une cl√© sur :\nhttps://aistudio.google.com/app/apikey\n\n(Elle sera stock√©e localement dans votre navigateur)"
        );
        if (!apiKey || apiKey.trim() === "") return;
        apiKey = apiKey.trim();
        localStorage.setItem("gemini-api-key", apiKey);
        window.updateKeyManagementVisibility?.();
      }

      const correctBtn = document.getElementById("correctBtn");
      const originalText = correctBtn.textContent;
      const resultsCard = document.getElementById("resultsCard");
      const errorsContainer = document.getElementById("errorsContainer");

      try {
        correctBtn.disabled = true;
        correctBtn.innerHTML = '<span class="loading">Analyse en cours</span>';

        resultsCard.classList.add("visible");
        const title = document.getElementById("errorsTitle");
        if (title) title.textContent = "Analyse en cours‚Ä¶";

        errorsContainer.innerHTML = `
          <div class="empty-state">
            <div class="loading">Lecture et analyse du document</div>
          </div>
        `;

        const buffer = await file.arrayBuffer();
        const genAI = new GoogleGenerativeAI(apiKey);

        const model = buildModel(genAI, {
          thinkingLevel: "HIGH",
          mediaResolution: "MEDIA_RESOLUTION_HIGH"
        });

        let parts;

        if (isPdf) {
          const base64 = arrayBufferToBase64(buffer);
          const prompt = makePrompt("pdf");
          parts = [
            { inlineData: { mimeType: "application/pdf", data: base64 } },
            { text: prompt }
          ];
        } else {
          const labeled = clampText(await extractDocxToLabeledText(buffer), 140000);
          if (!labeled) {
            throw new Error("Impossible d'extraire du texte du DOCX (document vide ?).");
          }
          const prompt = makePrompt("docx");
          parts = [
            { text: prompt + "\n\n--- DOCUMENT BALIS√â ---\n" + labeled }
          ];
        }

        const result = await generateWithTimeout(model, parts, CLIENT_TIMEOUT_MS);

        let responseText = (await result.response).text().trim();
        if (responseText.startsWith("```")) {
          responseText = responseText
            .replace(/^```[a-z]*\s*/i, "")
            .replace(/\s*```$/, "");
        }

        window.allErrors = JSON.parse(responseText);
        if (!Array.isArray(window.allErrors)) {
          throw new Error("La r√©ponse n'est pas un tableau JSON.");
        }

        window.displayErrors(window.allErrors);

      } catch (error) {
        if (isTimeout(error)) {
          showBigErrorOnPage(
            error,
            "‚è±Ô∏è Timeout : la requ√™te a d√©pass√© 5 minutes (300 secondes)."
          );
        } else {
          showBigErrorOnPage(error);
        }
        console.error("Erreur:", error);
      } finally {
        correctBtn.disabled = false;
        correctBtn.textContent = originalText;
      }
    }

    document.getElementById("correctBtn").addEventListener("click", correctDocument);
  </script>
</body>
</html>
